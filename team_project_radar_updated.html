<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>团队模型 · 叠加雷达对比</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
<style>
:root{
  --bg:#0b1020;--card:#121833;--ink:#e7ecff;--muted:#9aa4c9;--line:#1c2447;
  --good:#4ade80;--warn:#f59f0b;--bad:#ff5c9a;--hl:#2a3b7a
}
*{box-sizing:border-box}
html,body{margin:0;background:linear-gradient(180deg,#0b1020,#0f1431);color:var(--ink);font-family:'Noto Sans SC',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.container{max-width:1200px;margin:24px auto;padding:0 16px}
h1{font-size:22px;margin:0 0 12px}
h2{font-size:18px;margin:18px 0 8px;color:#e7ecff}
.card{
  background:linear-gradient(180deg,#10173a 0%, #0e1430 100%);
  border:1px solid var(--line);border-radius:16px;padding:14px;margin:12px 0;
  box-shadow:0 10px 30px rgba(0,0,0,.24)
}
.row{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:980px){.row{grid-template-columns:1fr 1fr}}
.caption{color:var(--muted);font-size:12px;margin-top:6px}
.toolbar{
  display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:6px 0 12px
}
select,button,input[type="number"]{
  background:#0e1430;color:#e7ecff;border:1px solid var(--line);
  border-radius:10px;padding:8px 10px;font-size:13px
}
label{font-size:13px;color:var(--muted);margin-right:8px}
.badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
.badge{
  padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);background:#0e1430;color:#cfe0ff
}
canvas{width:100%;height:420px;max-height:54vh}
.kv{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
.kv b{color:#fff}
.small{font-size:12px;color:var(--muted)}
footer{opacity:.7;font-size:12px;margin:18px 0 10px}
hr{border:none;border-top:1px dashed #24305b;margin:10px 0}
</style>
</head>
<body>
<div class="container">
  <h1>团队模型 · 叠加雷达对比</h1>
  <div class="card">
    <div class="toolbar">
      <label>主业行业：
        <select id="industrySelect"></select>
      </label>

      <label>转型方向：
        <select id="transIndustrySelect"></select>
      </label>
      <label><input type="checkbox" id="showFusion"> 显示融合完美模型（主业×转型）</label>
      <label>主业权重：<input type="number" id="wMain" value="0.6" step="0.05" min="0" max="1" style="width:70px"></label>
      <label>转型权重：<input type="number" id="wTrans" value="0.4" step="0.05" min="0" max="1" style="width:70px"></label>
      <label>γ 协同：<input type="number" id="gamma" value="0.15" step="0.05" min="0" max="0.5" style="width:70px"></label>
      <label>人数分档：
        <select id="sizeSelect">
          <option value="Micro">微型（1–5）</option>
          <option value="Small">小型（6–15）</option>
          <option value="Medium" selected>中型（16–40）</option>
          <option value="Large">大型（41+）</option>
        </select>
      </label>
      <label><input type="checkbox" id="showIndividuals"> 叠加个体线（上限12）</label>
      <button id="regenBtn">生成模拟数据</button>
      <button id="saveBtn">把当前数据写入 localStorage</button>
    </div>
    <div class="small">提示：本页会自动尝试从 <code>localStorage</code> 读取多人 <b>生态16 + 潜力8</b> 的个人结果；若未找到，将自动生成模拟数据。</div>
  </div>

  <!-- 1) 团队模型：生态 & 潜力 -->
  <div class="row">
    <div class="card">
      <h2>1-1 团队 · 生态16 叠加（均值） vs 个人完美原型</h2>
      <canvas id="ecoChart"></canvas>
      <div class="caption">可勾选“叠加个体线”查看分布；完美原型用于快速对比“当前团队生态的理想差距”。</div>
    </div>
    <div class="card">
      <h2>1-2 团队 · 潜力8 叠加（均值） vs 个人完美原型</h2>
      <canvas id="potChart"></canvas>
      <div class="caption">潜力为个人层 8 维；此处聚合为团队均值并与个人完美原型对比。</div>
    </div>
  </div>

  <!-- 1-3) 团队模型（14维） · 高/中/低 + 团队完美原型 -->
  <div class="card">
    <h2>1-3 团队模型（14维）· 高/中/低 参考线 + 团队完美原型</h2>
    <canvas id="teamModelChart"></canvas>
    <div class="badges" id="teamBadges"></div>
    <div class="caption">团队分档与完美原型参考：底线维（看 p20）、尖刀维（看峰值 M）、混合维（均衡）。</div>
  </div>

  <footer>© 你的系统 · 本页为“读取 Dashboard 数据”的团队对比页（可单独部署）。</footer>
</div>

<script>
/* =============== 基础字典：维度命名 =============== */
const ECO16 = ['信任启动度','协作质量','关系韧性','影响半径','目标推进力','节奏管理','应变效率','幸福感','信息透明度','决策效率','创造力','结构思维','边界与主权','现实校准','自我驱动','学习氛围'];
const POT8  = ['领导潜力','创新潜力','艺术潜力','学习潜力','社交潜力','创业潜力','科研潜力','幸福潜力'];

// 团队 14 维（A=底线 6；B=尖刀 5；C=增益 3）
const TEAM14 = ['情绪稳定','协作质量','信任速度','节奏管理','应变效率','可持续度','目标推进力','领导力','创新潜力','影响半径','创业潜力','学习与迁移','科研深度','品牌/审美'];
const AXIS_TYPE_TEAM = { // A/B/C 分类
  '情绪稳定':'A','协作质量':'A','信任速度':'A','节奏管理':'A','应变效率':'A','可持续度':'A',
  '目标推进力':'B','领导力':'B','创新潜力':'B','影响半径':'B','创业潜力':'B',
  '学习与迁移':'C','科研深度':'C','品牌/审美':'C'
};

// 项目 12 维（A=底线 4；B=尖刀 3；C=混合 5）
const PROJ12 = ['交付节拍','协作与质量','风险与合规','可持续度','影响半径','GTM','领导与动员','创新引擎','学习与迁移','科研深度','品牌/审美','创业整合'];
const AXIS_TYPE_PROJ = {
  '交付节拍':'A','协作与质量':'A','风险与合规':'A','可持续度':'A',
  '影响半径':'B','GTM':'B','领导与动员':'B',
  '创新引擎':'C','学习与迁移':'C','科研深度':'C','品牌/审美':'C','创业整合':'C'
};

/* =============== 行业权重与特例阈值 =============== */
const INDUSTRY_WEIGHTS = {
  'SaaS/DevTools': {'交付节拍':3,'协作与质量':3,'风险与合规':2,'可持续度':2,'影响半径':2,'GTM':3,'领导与动员':2,'创新引擎':2,'学习与迁移':3,'科研深度':2,'品牌/审美':1,'创业整合':2},
  '消费互联网/UGC': {'交付节拍':2,'协作与质量':2,'风险与合规':1,'可持续度':2,'影响半径':3,'GTM':3,'领导与动员':2,'创新引擎':2,'学习与迁移':2,'科研深度':1,'品牌/审美':3,'创业整合':2},
  '电商/供应链': {'交付节拍':3,'协作与质量':3,'风险与合规':2,'可持续度':2,'影响半径':2,'GTM':3,'领导与动员':2,'创新引擎':1,'学习与迁移':2,'科研深度':1,'品牌/审美':1,'创业整合':2},
  'FinTech': {'交付节拍':2,'协作与质量':3,'风险与合规':3,'可持续度':2,'影响半径':2,'GTM':2,'领导与动员':2,'创新引擎':2,'学习与迁移':2,'科研深度':2,'品牌/审美':1,'创业整合':2},
  '医疗/生物': {'交付节拍':2,'协作与质量':2,'风险与合规':3,'可持续度':2,'影响半径':1,'GTM':1,'领导与动员':2,'创新引擎':2,'学习与迁移':2,'科研深度':3,'品牌/审美':1,'创业整合':1},
  '教育': {'交付节拍':2,'协作与质量':3,'风险与合规':2,'可持续度':2,'影响半径':2,'GTM':2,'领导与动员':2,'创新引擎':2,'学习与迁移':3,'科研深度':1,'品牌/审美':2,'创业整合':1},
  '游戏': {'交付节拍':2,'协作与质量':2,'风险与合规':1,'可持续度':2,'影响半径':3,'GTM':2,'领导与动员':2,'创新引擎':3,'学习与迁移':2,'科研深度':1,'品牌/审美':3,'创业整合':2},
  'AI/DeepTech': {'交付节拍':2,'协作与质量':2,'风险与合规':2,'可持续度':2,'影响半径':2,'GTM':2,'领导与动员':2,'创新引擎':3,'学习与迁移':3,'科研深度':3,'品牌/审美':1,'创业整合':2},
  '新能/硬件/制造': {'交付节拍':3,'协作与质量':2,'风险与合规':3,'可持续度':2,'影响半径':1,'GTM':2,'领导与动员':2,'创新引擎':2,'学习与迁移':2,'科研深度':2,'品牌/审美':1,'创业整合':2},
  '品牌/设计/内容': {'交付节拍':1,'协作与质量':2,'风险与合规':1,'可持续度':2,'影响半径':3,'GTM':2,'领导与动员':2,'创新引擎':2,'学习与迁移':2,'科研深度':1,'品牌/审美':3,'创业整合':2},
  '专业服务/咨询': {'交付节拍':2,'协作与质量':3,'风险与合规':2,'可持续度':2,'影响半径':2,'GTM':2,'领导与动员':3,'创新引擎':1,'学习与迁移':2,'科研深度':1,'品牌/审美':2,'创业整合':2}
};
// 行业额外“最低目标线”（体现你之前给的关键阈值例子）
const INDUSTRY_EXTRA_MIN = {
  'SaaS/DevTools': {'GTM':78,'交付节拍':78,'学习与迁移':75},
  '消费互联网/UGC': {'影响半径':82,'GTM':80,'品牌/审美':78},
  '电商/供应链': {'交付节拍':80,'协作与质量':78,'GTM':78},
  'FinTech': {'风险与合规':82,'协作与质量':78,'交付节拍':76},
  '医疗/生物': {'科研深度':85,'风险与合规':80,'协作与质量':75},
  '教育': {'协作与质量':78,'学习与迁移':80,'领导与动员':76},
  '游戏': {'创新引擎':82,'品牌/审美':80,'影响半径':80},
  'AI/DeepTech': {'科研深度':82,'创新引擎':82,'学习与迁移':80},
  '新能/硬件/制造': {'交付节拍':80,'风险与合规':80,'GTM':75},
  '品牌/设计/内容': {'品牌/审美':82,'影响半径':78,'GTM':76},
  '专业服务/咨询': {'领导与动员':80,'协作与质量':80,'交付节拍':76}
};

/* =============== 读取/模拟 Dashboard 数据 =============== */
/** 尝试从 localStorage 发现数据（兼容多种 key）；返回 {people:[{name,eco:{},pot:{}}], industry?} */
function readFromLocalStorage() {
  const candidates = [
    'DASHBOARD_DATA_V1','TEAM_DATA_V1','dashboard_people','dashboardData','peopleData','teamPeople','step_all_result'
  ];
  for (const k of candidates) {
    try {
      const raw = localStorage.getItem(k);
      if (!raw) continue;
      const obj = JSON.parse(raw);
      // 宽松判断
      if (Array.isArray(obj?.people) && obj.people.length && obj.people[0]?.eco && obj.people[0]?.pot) {
        return obj;
      }
      if (Array.isArray(obj) && obj.length && obj[0]?.eco && obj[0]?.pot) {
        return {people: obj};
      }
    } catch(e){}
  }
  return null;
}
/** 生成模拟 N 人数据（数值 55–90，带个体偏移），并写入内存但不强行覆盖 localStorage */
function mockTeam(N=12) {
  const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)];
  const people = Array.from({length:N}).map((_,i)=>{
    const eco={}, pot={};
    const ecoBias = (Math.random()*10-5);   // [-5,+5]
    const potBias = (Math.random()*10-5);
    ECO16.forEach((k,idx)=>{
      let base = 65 + (Math.sin((i+1)*(idx+1)) * 8) + ecoBias; // 有点个体/维度的波动
      base += (k==='协作质量'||k==='目标推进力') ? 5 : 0;
      eco[k] = clamp(base + randn(0,4), 40, 95);
    });
    POT8.forEach((k,idx)=>{
      let base = 66 + (Math.cos((i+2)*(idx+1)) * 9) + potBias;
      if (k==='领导潜力'||k==='创新潜力') base += 6;
      pot[k] = clamp(base + randn(0,5), 40, 96);
    });
    return {name:`成员${i+1}`, eco, pot};
  });
  return {people, industry:'SaaS/DevTools'};
}
function randn(mu=0, sigma=1){ // 高斯近似
  const u = Math.random()||1e-9, v = Math.random()||1e-9;
  return mu + sigma*Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
}
function clamp(v,min,max){return Math.max(min,Math.min(max,v))}

/* =============== 统计量：μ / p20 / M / coverage≥70 =============== */
function statsPerDim(people, dimList, kind='eco') {
  // 返回 { label: {mu, p20, max, cov70} }
  const out = {};
  dimList.forEach(label=>{
    const vals = people.map(p=>Number(p[kind]?.[label]??NaN)).filter(x=>!isNaN(x));
    const mu = vals.reduce((a,b)=>a+b,0)/(vals.length||1);
    const sorted = [...vals].sort((a,b)=>a-b);
    const p20 = sorted[Math.max(0, Math.floor(sorted.length*0.2)-1)] ?? (sorted[0]??0);
    const max = sorted[sorted.length-1] ?? 0;
    const cov70 = (vals.filter(v=>v>=70).length)/(vals.length||1);
    out[label] = {mu, p20, max, cov70};
  });
  return out;
}

/* =============== 团队14维：映射（来源于 24 维） =============== */
/** 给出每个团队维度对应的“来源维度组合”（均以 24 维为基本源头）。 */
const TEAM14_SOURCES = {
  '情绪稳定':      {eco:{'幸福感':0.4,'关系韧性':0.3,'节奏管理':0.3}},
  '协作质量':      {eco:{'协作质量':0.6,'信任启动度':0.25,'信息透明度':0.15}},
  '信任速度':      {eco:{'信任启动度':1.0}},
  '节奏管理':      {eco:{'节奏管理':1.0}},
  '应变效率':      {eco:{'应变效率':0.6,'现实校准':0.4}},
  '可持续度':      {eco:{'幸福感':0.5,'节奏管理':0.5}},
  '目标推进力':    {eco:{'目标推进力':1.0}},
  '领导力':        {pot:{'领导潜力':1.0}},
  '创新潜力':      {pot:{'创新潜力':1.0}},
  '影响半径':      {eco:{'影响半径':0.6}, pot:{'社交潜力':0.4}},
  '创业潜力':      {pot:{'创业潜力':1.0}},
  '学习与迁移':    {pot:{'学习潜力':0.7}, eco:{'应变效率':0.3}},
  '科研深度':      {pot:{'科研潜力':1.0}},
  '品牌/审美':     {pot:{'艺术潜力':0.7}, eco:{'创造力':0.3}}
};
/** 从 24 维统计量合成“团队维度”的 μ/p20/M */
function composeTeamAxisStats(ecoStats, potStats) {
  const out = {};
  for (const axis of TEAM14) {
    const spec = TEAM14_SOURCES[axis]||{};
    const parts = [];
    let wsum=0;
    const acc = {mu:0,p20:0,max:0};
    // eco 部分
    if (spec.eco){
      for (const k in spec.eco){
        const w = spec.eco[k]; wsum += w;
        const s = ecoStats[k] || {mu:0,p20:0,max:0};
        acc.mu  += w*s.mu;
        acc.p20 += w*s.p20;
        acc.max += w*s.max;
      }
    }
    // pot 部分
    if (spec.pot){
      for (const k in spec.pot){
        const w = spec.pot[k]; wsum += w;
        const s = potStats[k] || {mu:0,p20:0,max:0};
        acc.mu  += w*s.mu;
        acc.p20 += w*s.p20;
        acc.max += w*s.max;
      }
    }
    if (wsum>0){ acc.mu/=wsum; acc.p20/=wsum; acc.max/=wsum; }
    out[axis]=acc;
  }
  return out;
}
/** 将 μ/p20/M 合成为单分数：A/B/C 使用不同权重 */
function scoreByType(stats, axisTypeMap) {
  const out = {};
  for (const axis in stats) {
    const t = axisTypeMap[axis] || 'C';
    const s = stats[axis];
    let score;
    if (t==='A'){ score = 0.20*s.mu + 0.60*s.p20 + 0.20*s.max; }
    else if (t==='B'){ score = 0.30*s.mu + 0.10*s.p20 + 0.60*s.max; }
    else { score = 0.35*s.mu + 0.35*s.p20 + 0.30*s.max; }
    out[axis] = clamp(score, 0, 100);
  }
  return out;
}

/* =============== 团队完美原型 & 分档参考 =============== */
function teamPerfectArchetype(){ // 14维
  return TEAM14.map(ax=>{
    const t = AXIS_TYPE_TEAM[ax];
    if (t==='A') return 70;
    if (t==='B') return 85;
    return 70; // C
  });
}
function teamTierLines(){ // 返回 {High,Medium,Low} 三条参考线（14维）
  const line = name=>{
    return TEAM14.map(ax=>{
      const t = AXIS_TYPE_TEAM[ax];
      if (t==='A'){
        if (name==='High') return 72;
        if (name==='Medium') return 65;
        return 58;
      }else if (t==='B'){
        if (name==='High') return 85;
        if (name==='Medium') return 82;
        return 75;
      }else{
        if (name==='High') return 70;
        if (name==='Medium') return 64;
        return 60;
      }
    });
  };
  return {High:line('High'), Medium:line('Medium'), Low:line('Low')};
}

/* =============== 行业转型融合（TEAM14 维度） =============== */
const PROJ2TEAM = {
  '交付节拍':     {'节奏管理':0.6,'目标推进力':0.4},
  '协作与质量':   {'协作质量':1.0},
  '风险与合规':   {'情绪稳定':0.5,'应变效率':0.5},
  '可持续度':     {'可持续度':1.0},
  '影响半径':     {'影响半径':1.0},
  'GTM':         {'领导力':0.4,'目标推进力':0.4,'影响半径':0.2},
  '领导与动员':   {'领导力':1.0},
  '创新引擎':     {'创新潜力':0.7,'品牌/审美':0.3},
  '学习与迁移':   {'学习与迁移':1.0},
  '科研深度':     {'科研深度':1.0},
  '品牌/审美':    {'品牌/审美':1.0},
  '创业整合':     {'创业潜力':0.7,'目标推进力':0.3}
};
function industryTeamWeights(industry){
  const wproj = INDUSTRY_WEIGHTS[industry] || {};
  const accum = {}; const norm = {};
  for (const proj in wproj){
    const w = wproj[proj];
    const mapping = PROJ2TEAM[proj] || {};
    for (const teamAx in mapping){
      const m = mapping[teamAx];
      accum[teamAx] = (accum[teamAx]||0) + w*m;
      norm[teamAx]  = (norm[teamAx]||0)  + m;
    }
  }
  const out = {};
  TEAM14.forEach(ax=>{
    const a = accum[ax]||0, n = (norm[ax]||1);
    out[ax] = a / n || 0;
  });
  return out;
}
function industryTeamTarget(axis, industry){
  const wmap = industryTeamWeights(industry);
  const w = Math.max(0, Math.min(3, wmap[axis]||0));
  const t = AXIS_TYPE_TEAM[axis] || 'C';
  let tgt = 68 + 4*w + (t==='B'?4:(t==='C'?2:0));
  return clamp(tgt, 55, 92);
}
function industryTeamTemplateVector(industry){
  return TEAM14.map(ax=> industryTeamTarget(ax, industry));
}
function fusionTeamVector(mainIndustry, transIndustry, wMain=0.6, wTrans=0.4, gamma=0.15){
  const A = industryTeamTemplateVector(mainIndustry);
  const B = industryTeamTemplateVector(transIndustry);
  const F = [];
  for (let i=0;i<TEAM14.length;i++){
    const a = A[i], b = B[i];
    const synergy = Math.sqrt(Math.max(0,a)*Math.max(0,b));
    const v = wMain*a + wTrans*b + gamma*synergy;
    F.push(clamp(v, 0, 100));
  }
  return F;
}


/* =============== 项目：行业模板（人数自适应） =============== */
function baseIndustryTarget(axis, industry){
  const w = (INDUSTRY_WEIGHTS[industry]||{})[axis] || 2; // 默认中权重
  const t = AXIS_TYPE_PROJ[axis] || 'C';
  // 68 + 4*w + type bonus（B更高，C略高）
  let tgt = 68 + 4*w + (t==='B'?3:(t==='C'?1:0));
  const extra = (INDUSTRY_EXTRA_MIN[industry]||{})[axis];
  if (extra) tgt = Math.max(tgt, extra);
  return clamp(tgt, 0, 100);
}
function sizeAdjust(target, axis){
  const t = AXIS_TYPE_PROJ[axis] || 'C';
  const size = document.getElementById('sizeSelect').value;
  let delta = 0;
  if (size==='Micro'){
    if (t==='A') delta = -5;
    else if (t==='B') delta = 0; // 峰值不放宽
    else delta = -3;
  }else if (size==='Small'){
    if (t==='A') delta = -2;
    else if (t==='B') delta = 0;
    else delta = -1;
  }else if (size==='Medium'){
    delta = 0;
  }else if (size==='Large'){
    delta = +2;
  }
  return clamp(target + delta, 0, 100);
}
function industryTemplateVector(industry){
  return PROJ12.map(ax=> sizeAdjust(baseIndustryTarget(ax,industry), ax));
}

/* =============== 项目模型：从 24 维统计映射到 12 维 =============== */
// 每个项目轴由哪些“源维度”组成（都以 24 维为源），用来先合成 μ/p20/M 再加权
const PROJ12_SOURCES = {
  '交付节拍':   {eco:{'目标推进力':1,'节奏管理':1,'应变效率':1,'协作质量':1}},
  '协作与质量': {eco:{'协作质量':1,'信任启动度':0.7,'信息透明度':0.3}},
  '风险与合规': {eco:{'情绪稳定?':0,'现实校准':0.6,'应变效率':0.4}}, // 情绪稳定由上面组合体现，这里不直接使用缺失字段
  '可持续度':   {eco:{'幸福感':0.5,'节奏管理':0.5}},
  '影响半径':   {eco:{'影响半径':1}, pot:{'社交潜力':0.5}},
  'GTM':       {eco:{'目标推进力':0.8,'协作质量':0.7,'影响半径':0.7}},
  '领导与动员': {pot:{'领导潜力':1}},
  '创新引擎':   {pot:{'创新潜力':0.7}, eco:{'创造力':0.3}},
  '学习与迁移': {pot:{'学习潜力':0.7}, eco:{'应变效率':0.3}},
  '科研深度':   {pot:{'科研潜力':1}},
  '品牌/审美':  {pot:{'艺术潜力':0.7}, eco:{'创造力':0.3}},
  '创业整合':   {pot:{'创业潜力':1}, eco:{'影响半径':0.3}}
};
// 注意：上面的 '情绪稳定?' 只是占位；真正的情绪稳定我们已在团队14维合成，这里用现实校准/应变效率近似风险控制。

function composeProjectAxisStats(ecoStats, potStats){
  const out = {};
  for (const axis of PROJ12){
    const spec = PROJ12_SOURCES[axis]||{};
    let wsum=0; const acc={mu:0,p20:0,max:0};
    if (spec.eco){
      for (const k in spec.eco){
        if (!ecoStats[k]) continue;
        const w = spec.eco[k]; wsum += w;
        const s = ecoStats[k];
        acc.mu+=w*s.mu; acc.p20+=w*s.p20; acc.max+=w*s.max;
      }
    }
    if (spec.pot){
      for (const k in spec.pot){
        if (!potStats[k]) continue;
        const w = spec.pot[k]; wsum += w;
        const s = potStats[k];
        acc.mu+=w*s.mu; acc.p20+=w*s.p20; acc.max+=w*s.max;
      }
    }
    if (wsum>0){acc.mu/=wsum;acc.p20/=wsum;acc.max/=wsum;}
    out[axis]=acc;
  }
  return out;
}
function projectScoreVector(ecoStats, potStats){
  // 先得每轴 μ/p20/M，再用 A/B/C 权重合成分数
  const stats = composeProjectAxisStats(ecoStats, potStats);
  const scored = scoreByType(stats, AXIS_TYPE_PROJ);
  return PROJ12.map(ax=>scored[ax]??0);
}

/* =============== 个人完美原型（生态/潜力） =============== */
const PERFECT_ECO16 = ECO16.map(k=>{
  // 给几个关键生态略高目标
  if (k==='协作质量' || k==='目标推进力' || k==='信任启动度') return 80;
  if (k==='幸福感') return 78;
  return 78;
});
const PERFECT_POT8  = POT8.map(k=>{
  if (k==='领导潜力' || k==='创新潜力') return 82;
  return 78;
});

/* =============== 计算指标：TSI/TRI/RDI（显示徽章用） =============== */
function computeTRI(ecoStats, potStats){
  // 简化版：在 24 维上平均 (μ-p20)/100 和 (max-μ)/100 的加权
  const dims = [...ECO16, ...POT8];
  let a=0,b=0,n=0;
  dims.forEach(k=>{
    const s = (ECO16.includes(k)? ecoStats[k]: potStats[k]) || null;
    if (!s) return;
    a += (s.mu - s.p20)/100;
    b += (s.max - s.mu)/100;
    n++;
  });
  if (!n) return 0;
  return clamp(0.6*(a/n) + 0.4*(b/n), 0, 1);
}
function computeRDI(potStats){ // 尖刀 5 维的单点失效风险（仅 1 人≥85）
  const sharpDims = ['领导潜力','创新潜力','创业潜力','学习潜力','科研潜力'];
  // 估算：用 max 与 μ 差距很大 & cov70 低视为单点（无逐人明细，做近似）
  let risky=0,total=0;
  sharpDims.forEach(k=>{
    const s = potStats[k]; if (!s) return;
    total++;
    const singleLike = (s.max>=85) && (s.mu<75) && (s.p20<65);
    if (singleLike) risky++;
  });
  return total? risky/total : 0;
}
function computeTSI(team14Score){
  // 简化：A/B/C 加权
  let a=0,ac=0,b=0,bc=0,c=0,cc=0;
  TEAM14.forEach((ax,i)=>{
    const t = AXIS_TYPE_TEAM[ax];
    const v = team14Score[i];
    if (t==='A'){a+=v;ac++;} else if (t==='B'){b+=v;bc++;} else {c+=v;cc++;}
  });
  const A = ac? a/ac:0, B = bc? b/bc:0, C = cc? c/cc:0;
  return clamp(0.5*A + 0.3*B + 0.2*C, 0, 100);
}

/* =============== 渲染 =============== */
let ecoChart, potChart, teamModelChart, projectChart;

function makeRadar(ctx, labels, datasets){
  return new Chart(ctx, {
    type:'radar',
    data:{labels, datasets},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{position:'top', labels:{color:'#e7ecff', boxWidth:14, boxHeight:14}}
      },
      scales:{
        r:{
          angleLines:{color:'#223059'},
          grid:{color:'#1f2a52'},
          pointLabels:{color:'#cfe0ff', font:{size:11}},
          suggestedMin:40, suggestedMax:100,
          ticks:{backdropColor:'transparent', color:'#9fb3ff', showLabelBackdrop:false, stepSize:10}
        }
      },
      elements:{
        line:{borderWidth:2},
        point:{radius:2}
      }
    }
  });
}

function palette(i, alpha=0.25){
  // 生成可区分的颜色（HSL）
  const h = (i*47) % 360;
  return `hsla(${h}deg, 80%, 60%, ${alpha})`;
}

/* =============== 主流程：加载→计算→渲染 =============== */
const industrySelect = document.getElementById('industrySelect');
const transIndustrySelect = document.getElementById('transIndustrySelect');
const showFusion = document.getElementById('showFusion');
const wMainInput = document.getElementById('wMain');
const wTransInput = document.getElementById('wTrans');
const gammaInput = document.getElementById('gamma');
const sizeSelect = document.getElementById('sizeSelect');
const showIndividuals = document.getElementById('showIndividuals');

function initIndustryOptions(){
  const keys = Object.keys(INDUSTRY_WEIGHTS);
  industrySelect.innerHTML = keys.map(k=>`<option value="${k}">${k}</option>`).join('');
transIndustrySelect.innerHTML = keys.map(k=>`<option value="${k}">${k}</option>`).join('');
}
initIndustryOptions();

let DATA = readFromLocalStorage() || mockTeam(12);

function saveToLocal(){
  localStorage.setItem('TEAM_DATA_V1', JSON.stringify(DATA));
  alert('已写入 localStorage: TEAM_DATA_V1');
}

function regenerate(){
  const size = sizeSelect.value;
  const n = size==='Micro'? 5 : size==='Small'? 10 : size==='Medium'? 18 : 36;
  DATA = mockTeam(n);
  DATA.industry = industrySelect.value;
  updateAll();
}

document.getElementById('saveBtn').addEventListener('click', saveToLocal);
document.getElementById('regenBtn').addEventListener('click', regenerate);
industrySelect.addEventListener('change', ()=>{ DATA.industry = industrySelect.value; updateAll(); });
transIndustrySelect.addEventListener('change', ()=>{ updateAll(); });
[showFusion, wMainInput, wTransInput, gammaInput].forEach(el=> el.addEventListener('change', updateAll));
sizeSelect.addEventListener('change', updateAll);
showIndividuals.addEventListener('change', updateAll);

function updateAll(){
  // 读取 24 维统计
  const ecoStats = statsPerDim(DATA.people, ECO16, 'eco');
  const potStats = statsPerDim(DATA.people, POT8,  'pot');

  // 1) 团队生态/潜力 均值 vs 个人完美原型
  const ecoMean = ECO16.map(k=>ecoStats[k]?.mu ?? 0);
  const potMean = POT8.map(k=>potStats[k]?.mu ?? 0);

  // 个体线（最多12条）
  const indivEcoDS = [];
  const indivPotDS = [];
  if (showIndividuals.checked){
    const sample = DATA.people.slice(0,12);
    sample.forEach((p,idx)=>{
      indivEcoDS.push({
        label: p.name, data: ECO16.map(k=>p.eco[k]??0),
        borderColor: palette(idx, .4), backgroundColor: palette(idx, .07), borderWidth:1, pointRadius:0
      });
      indivPotDS.push({
        label: p.name, data: POT8.map(k=>p.pot[k]??0),
        borderColor: palette(idx+6, .4), backgroundColor: palette(idx+6, .07), borderWidth:1, pointRadius:0
      });
    });
  }

  // 绘制生态
  const ecoDS = [
    ...indivEcoDS,
    {label:'团队 · 生态(均值)', data:ecoMean, borderColor:'#4ade80', backgroundColor:'rgba(74,222,128,.10)'},
    {label:'个人完美原型', data:PERFECT_ECO16, borderColor:'#9aa4c9', borderDash:[6,4], backgroundColor:'rgba(154,164,201,.06)'}
  ];
  if (ecoChart){ ecoChart.destroy(); }
  ecoChart = makeRadar(document.getElementById('ecoChart'), ECO16, ecoDS);

  // 绘制潜力
  const potDS = [
    ...indivPotDS,
    {label:'团队 · 潜力(均值)', data:potMean, borderColor:'#60a5fa', backgroundColor:'rgba(96,165,250,.10)'},
    {label:'个人完美原型', data:PERFECT_POT8, borderColor:'#9aa4c9', borderDash:[6,4], backgroundColor:'rgba(154,164,201,.06)'}
  ];
  if (potChart){ potChart.destroy(); }
  potChart = makeRadar(document.getElementById('potChart'), POT8, potDS);

  // 2) 团队模型 14 维：先从 24 维统计合成 μ/p20/M，再按 A/B/C 权重合成分数
  const team14Stats = composeTeamAxisStats(ecoStats, potStats);
  const team14ScoreMap = scoreByType(team14Stats, AXIS_TYPE_TEAM);
  const team14Score = TEAM14.map(ax=> team14ScoreMap[ax]||0);

  const tierLines = teamTierLines();
  const teamPerfect = teamPerfectArchetype();

  let teamFusion = null;
  if (showFusion && showFusion.checked){
    const mi = industrySelect.value || DATA.industry;
    const ti = transIndustrySelect.value || mi;
    const wm = parseFloat(wMainInput.value||'0.6');
    const wt = parseFloat(wTransInput.value||'0.4');
    const gm = parseFloat(gammaInput.value||'0.15');
    teamFusion = fusionTeamVector(mi, ti, wm, wt, gm);
  }

  const teamDS = [
    {label:'团队当前', data:team14Score, borderColor:'#f59f0b', backgroundColor:'rgba(245,159,11,.10)'},
    {label:'团队完美原型', data:teamPerfect, borderColor:'#a5b4fc', borderDash:[8,4], backgroundColor:'rgba(165,180,252,.06)'},
    ...(teamFusion ? [{label:`融合完美模型（${industrySelect.value}×${transIndustrySelect.value}）`, data:teamFusion, borderColor:'#22d3ee', borderDash:[6,2], backgroundColor:'rgba(34,211,238,.06)'}] : []),
    {label:'高配参考', data:tierLines.High, borderColor:'rgba(74,222,128,.85)', borderDash:[3,3], backgroundColor:'rgba(74,222,128,.05)'},
    {label:'中配参考', data:tierLines.Medium, borderColor:'rgba(96,165,250,.85)', borderDash:[3,3], backgroundColor:'rgba(96,165,250,.05)'},
    {label:'低配参考', data:tierLines.Low, borderColor:'rgba(255,92,154,.85)', borderDash:[3,3], backgroundColor:'rgba(255,92,154,.05)'}
  ];
  if (teamModelChart){ teamModelChart.destroy(); }
  teamModelChart = makeRadar(document.getElementById('teamModelChart'), TEAM14, teamDS);

  // 团队徽章（TSI/TRI/RDI）
  const TRI = computeTRI(ecoStats, potStats);
  const RDI = computeRDI(potStats);
  const TSI = computeTSI(team14Score);
  const badges = document.getElementById('teamBadges');
  badges.innerHTML = `
    <span class="badge">TSI 团队实力：<b>${TSI.toFixed(1)}</b></span>
    <span class="badge">TRI 分化风险：<b>${(TRI*100).toFixed(0)}%</b></span>
    <span class="badge">RDI 单点风险：<b>${(RDI*100).toFixed(0)}%</b></span>
    <span class="badge">成员数：<b>${DATA.people.length}</b></span>
    <span class="badge">行业：<b>${DATA.industry}</b></span>
  `;

  // 3) 项目模型 12 维：从 24 维统计映射为项目侧，再与行业模板对比（人数自适应）
  const projectVec = projectScoreVector(ecoStats, potStats);
  const industry = industrySelect.value || DATA.industry;
  const templateVec = industryTemplateVector(industry);

  const projDS = [
    {label:'项目模型（团队映射）', data:projectVec, borderColor:'#22d3ee', backgroundColor:'rgba(34,211,238,.10)'},
    {label:`行业完美模板（${industry}）`, data:templateVec, borderColor:'#eab308', borderDash:[6,4], backgroundColor:'rgba(234,179,8,.06)'}
  ];
  if (projectChart){ projectChart.destroy(); }
  projectChart = makeRadar(document.getElementById('projectChart'), PROJ12, projDS);

  // 关键指标 KV
  const fit = archetypeFit(projectVec, templateVec);
  document.getElementById('projectKV').innerHTML = `
    <span class="badge">PAF 行业贴合度：<b>${fit.toFixed(1)}</b></span>
    <span class="badge">当前行业：<b>${industry}</b></span>
    <span class="badge">人数分档：<b>${sizeSelect.value}</b></span>
  `;
}
function archetypeFit(actual, target){
  // 100 - 平均缺口（每维不足的部分取正）
  let gap=0, n=actual.length;
  for (let i=0;i<n;i++){
    const g = Math.max(0, target[i]-actual[i]);
    gap += g;
  }
  const avgGap = gap/n;
  return clamp(100 - avgGap, 0, 100);
}

// 初始化选择器
(function bootstrap(){
  if (DATA.industry && INDUSTRY_WEIGHTS[DATA.industry]){
    industrySelect.value = DATA.industry;
  }
  // 根据实际人数，预选 size 档
  const n = (DATA.people||[]).length;
  if (n<=5) sizeSelect.value='Micro';
  else if (n<=15) sizeSelect.value='Small';
  else if (n<=40) sizeSelect.value='Medium';
  else sizeSelect.value='Large';
  updateAll();
})();
</script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="bridge.js"></script>
<script>
  // 可选：把后台的最新配置灌进 localStorage，让前端显示使用后台命名/权重
  Bridge.loadConfigToLocal();
</script>

</body>
</html>\n    ${ (showFusion && showFusion.checked) ? `<span class=\"badge\">融合：<b>${industrySelect.value}×${transIndustrySelect.value}</b>（w=${parseFloat(wMainInput.value||0.6).toFixed(2)}/${parseFloat(wTransInput.value||0.4).toFixed(2)}, γ=${parseFloat(gammaInput.value||0.15).toFixed(2)}）</span>` : '' }
